{% extends "base.html" %}

{% block title %} 食品購入 {% endblock %}

{% block main %}

<body>

<nav class="navbar navbar-expand-xl navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="{% url 'userhome:home' %}">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
  		<path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8"/>
	</svg>
</a>
      <ul class="navbar-nav m-auto">
      	<li class="nav-item">
          <a class="navbar-brand" href="{% url 'userhome:home' %}">AutoOrder</a>
        </li>
      </ul>
         <ul class="navbar-nav mt-auto">
        <li class="nav-item">
          <a class="nav-link active" href="{% url 'login:logout' %}" >ログアウト
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-box-arrow-right" viewBox="0 0 16 16">
  			<path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z"/>
  			<path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z"/>
		　</svg></a>
        </li>
      </ul>
  </div>
</nav>

<nav class="ms-3 my-2" style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'userhome:home' %}">Home</a></li>
    <li class="breadcrumb-item active" aria-current="page">食品購入</li>
  </ol>
</nav>

<br>

<div class="center">
  <video id="qr-video" width="300" height="200" autoplay></video>
  <script src="https://rawgit.com/cozmo/jsQR/master/dist/jsQR.js"></script>
  <script>
    const video = document.getElementById('qr-video');

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then((stream) => {
        video.srcObject = stream;
        video.play();
        const canvasElement = document.createElement('canvas');
        const canvas = canvasElement.getContext('2d');
        setInterval(() => {
          canvasElement.width = video.videoWidth;
          canvasElement.height = video.videoHeight;
          canvas.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
          const imageData = canvas.getImageData(0, 0, video.videoWidth, video.videoHeight);
          const code = jsQR(imageData.data, imageData.width, imageData.height);
          if (code) {
            console.log('QRコードの内容:', code.data);
         	// ここでQRコードのデータを利用する処理を記述します
            addToCart(code.data); // カートに追加する処理を呼び出し
            showMessage(`読み取りました: ${code.data}`);
          }
        }, 100);
      })
      .catch((err) => {
        console.error('カメラのアクセスを許可してください:', err);
      });
    
    function addToCart(item_id) {
        fetch(`/userhome/add_to_cart/${item_id}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'), // CSRFトークンを取得してヘッダーに含める
            },
            body: JSON.stringify({ quantity: 1 }), // 商品の数量などを必要に応じて送信
        })
            .then(response => response.json())
            .then(data => {
                console.log('カートに商品が追加されました:', data);
            })
            .catch(error => {
                console.error('エラーが発生しました:', error);
            });
    }

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }
    function showMessage(text) {
        messageDiv.innerText = text;
    }
  </script>
<div class="right">
<a href="{% url 'userhome:cartcontents' %}"><button type="button" class="btn btn-warning m-top-20px m-r-30px">カートに移動する</button></a>
</div>
</div>
</body>

{% endblock %}

